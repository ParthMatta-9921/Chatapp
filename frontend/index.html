<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App Test</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    #messages { border: 1px solid #ccc; padding: 1em; height: 300px; overflow-y: scroll; margin-bottom: 1em; }
    input, button { margin: 0.25em; }
  </style>
</head>
<body>

<h2>Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>

<h2>Chat</h2>
<input id="friendId" placeholder="Friend User ID">
<button onclick="connect()">Connect WebSocket</button>

<div id="status"></div>

<div id="messages"></div>

<input id="chatInput" placeholder="Type a message">
<button onclick="sendMessage()">Send</button>
<button onclick="loadHistory()">Load History</button>

<script>
let token = null;
let ws = null;
let currentUserId = null;

async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch("http://localhost:8000/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();
  if (res.ok) {
    token = data.access_token;
    document.getElementById("status").innerText = "Login successful!";
  } else {
    alert("Login failed: " + data.detail);
  }
}

function connect() {
  if (!token) return alert("Login first");

  const url = `ws://localhost:8000/chat/ws?token=${token}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    document.getElementById("status").innerText = "WebSocket connected!";
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const messagesDiv = document.getElementById("messages");

    if (data.type === "message") {
      const text = `[${data.timestamp}] ${data.from} → ${data.to || "you"}: ${data.content}`;
      messagesDiv.innerHTML += `<div>${text}</div>`;
    } else if (data.type === "history") {
      messagesDiv.innerHTML = "<strong>History:</strong><br>";
      for (const msg of data.messages) {
        const text = `[${msg.timestamp}] ${msg.from} → ${msg.to}: ${msg.content}`;
        messagesDiv.innerHTML += `<div>${text}</div>`;
      }
    } else if (data.error) {
      messagesDiv.innerHTML += `<div style="color:red;">Error: ${data.error}</div>`;
    }
  };

  ws.onclose = () => {
    document.getElementById("status").innerText = "WebSocket disconnected";
  };
}

function sendMessage() {
  if (!ws) return alert("WebSocket not connected");
  const to = parseInt(document.getElementById("friendId").value);
  const content = document.getElementById("chatInput").value;

  const msg = {
    type: "message",
    to,
    content
  };
  ws.send(JSON.stringify(msg));
}

function loadHistory() {
  if (!ws) return alert("WebSocket not connected");
  const friend_id = parseInt(document.getElementById("friendId").value);

  const req = {
    type: "history",
    friend_id
  };
  ws.send(JSON.stringify(req));
}
</script>
</body>
</html>
